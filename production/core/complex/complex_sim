#!/bin/bash
#Author: Atharva Tilewale
#Protein simulation made easy with GRAVITy

# Change working directory
project_dir=$(head -n 1 "/etc/GRAVITy/current_dir.txt")
cd $project_dir
# Source the color script
source /etc/GRAVITy/colors
echo start >$project_dir/run_parameters.conf
source $project_dir/run_parameters.conf
param_file=$project_dir/run_parameters.conf

# Function to stop the spinner if an error occurs
stop_spinner() {
    if [ ! -z "$spinner_pid" ]; then
        kill $spinner_pid
    fi
}

# Function to display a rotating loader with custom text
show_spinner() {
    local pid=$1      # Process ID to monitor
    local message=$2  # Custom loading message
    local spin='-\|/' # Spinner characters
    local i=0

    # Loop to display the spinner until the task completes
    while kill -0 $pid 2>/dev/null; do
        i=$(((i + 1) % 4))
        printf "\r${spin:$i:1} %s..." "$message"
        sleep 0.1
    done
    printf "\r%s...        \n" "$message"
}

#Loaders
#Download loader
download_loader() {
    show_spinner $! "Downloading $file_download_name"
    wait $!
    if [ $? -ne 0 ]; then
        echo -e "${LIGHT_RED}Error: Download failed. Please check your internet connection and try again.${NC}"
        exit 1
    else
        echo -e ${LIGHT_GREEN}$file_download_name "downloaded successfully!"${NC}
        sleep 1.0
    fi
}

#check internet connection
check_internet() {
    if ping -c 1 -W 1 8.8.8.8 &>/dev/null; then
        echo -e "Status [${LIGHT_GREEN}Online${NC}]"
    else
        echo -e "Status [${LIGHT_RED}Offline${NC}]"
        echo -e "${LIGHT_RED}It is recommended to connect to the internet while process is going on."
        echo -e "If any dependencies are missing then you may not able to download.${NC}"
    fi
}

#Check dependencies
check_dependencies() {
    command -v gmx >/dev/null 2>&1 || { echo -e ${LIGHT_RED} >&2 "GROMACS not found. Please install GROMACS and add it to your PATH.${NC}" 
        sleep 1.0
        echo "Installing GROMACS..."
        sudo apt-get install gromacs; exit 1; }
    command -v obabel >/dev/null 2>&1 || { echo -e ${LIGHT_RED} >&2 "OpenBabel not found. Please install OpenBabel and add it to your PATH.${NC}"
        sleep 1.0
        echo "Installing openbabel..."
        sudo apt-get install openbabel; exit 1; }
    command -v wget >/dev/null 2>&1 || { echo -e ${LIGHT_RED} >&2 "wget not found. Please install wget to download necessary files.${NC}" 
        sleep 1.0
        echo "Installing wget..."
        sudo apt-get install wget; exit 1; }
}

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check Python3 and pip3 installation
if command_exists python3; then
    if command_exists pip3; then
        # Check if networkx is installed and its version
        networkx_version=$(pip3 show networkx 2>/dev/null | grep Version | awk '{print $2}')
        if [ -n "$networkx_version" ]; then
            if [ "$networkx_version" == "2.3" ]; then
                echo
            else
                echo "networkx is installed, but version is $networkx_version. Expected version: 2.3"
                echo "Installing networkx v2.3"
                pip3 install networkx==2.3
            fi
        else
            echo "networkx is not installed."
            echo "Installing networkx v2.3"
            pip3 install networkx==2.3
        fi
    else
        echo "pip3 is not installed"
        echo "Installing pip3"
        sudo apt install python3-pip
    fi
else
    echo "Python3 is not installed"
    echo "Installing Python3"
    sudo apt-get install python3
fi

# Function to prompt user for input
prompt_user() {
    read -p "$1" choice
    echo "$choice"
}

# Function to check if a file exists and prompt to overwrite
check_file_exists() {
    local file=$1
    if [ -f "$file" ]; then
        echo -e ${LIGHT_CYAN}"File '$file' already exists."
        while true; do
            read -p "Do you want to continue and overwrite the file? (y/n): " choice
            echo -e ${NC}
            case $choice in
            [Yy]*)
                echo "Proceeding with overwriting the file."
                return 0
                ;;
            [Nn]*)
                echo "Aborting process."
                return 1
                ;;
            *) echo "Please answer yes or no." ;;
            esac
        done
    fi
    return 0
}

#Retrieve Complex Molecules
retrieve_complex(){
    check_file_exists "$project_dir/protein.pdb" || return
    check_file_exists "$project_dir/ligand.pdbqt" || return
    read -p "Enter the path to your protein file (.pdb): " protein_path
    if [[ ! -f "$protein_path" ]]; then
        echo -e "${LIGHT_RED}Error: $protein_path file does not exist.${NC}"
        return
    else
        cp $protein_path $project_dir/protein.pdb
    fi
    read -p "Enter the path to your protein file (.pdbqt): " ligand_path
    if [[ ! -f "$ligand_path" ]]; then
        echo -e "${LIGHT_RED}Error: $ligand_path file does not exist.${NC}"
        return
    else
        cp $ligand_path $project_dir/ligand.pdbqt
    fi
    if [[ -f "$project_dir/protein.pdb" ]]; then
        if [[ -f "$project_dir/ligand.pdbqt" ]]; then
            echo -e "${LIGHT_GREEN}Molecules retrieved successfully...${NC}"
        fi
    else
        echo -e "${LIGHT_RED}Unable to fetch the molecules, please ensure you enter the correct path...${NC}"
    fi
    echo
}

force_field() {
    echo -e "${LIGHT_BLUE}Select a force field:${NC}"
    PS3="Enter your choice: "
    forcefields=("charmm36" "amber99sb" "charmm27" "gromos54a7" "oplsaa" "Other")
    select ff in "${forcefields[@]}"; do
        case $ff in
        "Other")
            read -p "Enter custom force field: " ff
            break
            ;;
        *)
            break
            ;;
        esac
    done
}

water_model() {
    echo -e "${LIGHT_BLUE}Select a water model:${NC}"
    PS3="Enter your choice: "
    watermodels=("spce" "tip3p" "tip4p" "tip5p" "Other")
    select wm in "${watermodels[@]}"; do
        case $wm in
        "Other")
            read -p "Enter custom water model: " wm
            break
            ;;
        *)
            break
            ;;
        esac
    done
}

# Function to fix PDB file using PDBFixer
pdb_fixer() {
    echo
    pdbfixer --pdbid="$pdb_id" --keep-heterogens=none --add-residues --replace-nonstandard --add-atoms=all --ph=7.0 --output=$project_dir/protein.pdb --verbose >/dev/null 2>&1 &
    pdbfix_loader
}

# Function to remove HETATM lines
remove_hetatm() {
    if grep -q "HETATM" $project_dir/protein.pdb; then
        echo "Removing HETATM entries from protein.pdb..."
        sed -i '/^HETATM/d' $project_dir/protein.pdb
    fi
}

# Function to generate protein topology
prepare_protein_topology(){
    # Check auto_check function
    # if [[ $(auto_check) == true ]]; then
    #     remove_hetatm
    #     gmx pdb2gmx -f "$project_dir/protein.pdb" -o "$project_dir/protein.gro" -ff "$ff" -water "$wm" -ignh >/dev/null 2>&1
    #     local exit_status=$?
    #     if [[ $exit_status -ne 0 ]]; then
    #         echo -e "${LIGHT_RED}Error: Failed to generate protein topology. Attempting to fix PDB file.${NC}"
    #         pdb_fixer || {
    #             echo -e "${LIGHT_RED}Error: PDB fixer failed. Exiting.${NC}"
    #             exit 1
    #         }

    #         # Retry GROMACS pdb2gmx after fixing
    #         gmx pdb2gmx -f "$project_dir/protein.pdb" -o "$project_dir/protein.gro" -ff "$ff" -water "$wm" -ignh >/dev/null 2>&1
    #         exit_status=$?
    #         if [[ $exit_status -ne 0 ]]; then
    #             echo -e "${LIGHT_RED}Error: Topology generation failed after fixing.${NC}"
    #             exit 1
    #         fi
    #     fi
    # else
        # Check if protein file exists
        if [[ ! -f "$project_dir/protein.pdb" ]]; then
            echo -e "${LIGHT_RED}Error: protein.pdb file does not exist.${NC}"
            read -p "Do you want to download the protein structure (y/n): " response
            if [[ "$response" == "y" ]]; then
                download_protein || {
                    echo -e "${LIGHT_RED}Error: Failed to download protein.${NC}"
                    exit 1
                }
            else
                echo -e "${LIGHT_RED}Aborting: No PDB file provided.${NC}"
                exit 1
            fi
        fi

        # Remove HETATM entries
        remove_hetatm
        echo
        force_field
        echo
        water_model

        # Generate protein topology
        echo "Generating Protein Topology..."
        gmx pdb2gmx -f "$project_dir/protein.pdb" -o "$project_dir/protein.gro" -ff "$ff" -water "$wm" -ignh >/dev/null 2>&1
        local exit_status=$?
        if [[ $exit_status -ne 0 ]]; then
            echo -e "${LIGHT_RED}Error: Failed to generate protein topology. Attempting to fix PDB file.${NC}"
            pdb_fixer || {
                echo -e "${LIGHT_RED}Error: PDB fixer failed. Exiting.${NC}"
                exit 1
            }

            # Retry GROMACS pdb2gmx after fixing
            gmx pdb2gmx -f "$project_dir/protein.pdb" -o "$project_dir/protein.gro" -ff "$ff" -water "$wm" -ignh >/dev/null 2>&1
            exit_status=$?
            if [[ $exit_status -ne 0 ]]; then
                echo -e "${LIGHT_RED}Error: Topology generation failed after fixing.${NC}"
                exit 1
            fi
        fi
    # fi

    # Success message
    echo -e "${LIGHT_GREEN}Protein topology generated successfully.${NC}"
    echo
    sleep 1.0
}


prepare_ligand_topology() {
    echo -e "${YELLOW}------------------------------------"
    echo -e "       Prepare Ligand Topology"
    echo -e "------------------------------------${NC}"
    while true; do
        echo -e "${LIGHT_PURPLE}[${NC}01${LIGHT_PURPLE}]${NC} Prepare .mol2 file"
        echo -e "${LIGHT_PURPLE}[${NC}02${LIGHT_PURPLE}]${NC} Fix .mol2 file"
        echo -e "${LIGHT_PURPLE}[${NC}03${LIGHT_PURPLE}]${NC} Prepare ligand parameter file"
        echo -e "${LIGHT_PURPLE}[${NC}04${LIGHT_PURPLE}]${NC} Generate ligand gro file"
        echo -e "${LIGHT_PURPLE}[${NC}05${LIGHT_PURPLE}]${NC} Generate complex.gro file and edit topol.top"
        echo -e "${LIGHT_PURPLE}[${NC}06${LIGHT_PURPLE}]${NC} Back to Main Menu"
        echo -e "${YELLOW}------------------------------------"
        read -p "Enter your choice [1-6]: " lig_top_choice

        case $lig_top_choice in
            1) 
                lig_pdbqt_file="lig.pdbqt"
                if [ ! -f "$lig_pdbqt_file" ]; then
                    echo "$lig_pdbqt_file does not exist."
                    exit 1
                fi
                if command -v obabel &> /dev/null 
                then
                    check_file_exists "lig.pdb" || return
                    obabel lig.pdbqt -O lig.pdb
                    if [ -f "lig.pdb" ]; then
                        obabel lig.pdb -O lig.mol2 -h
                        prepare_ligand_topology
                    else
                        echo "lig.pdb file does not exits. Please ensure the OpenBabel is properly installed and try again"
                        exit 1
                    fi
                else
                    echo "Open Babel is not installed. Would you like to install?"
                    while true; do
                        echo "Select option"
                        echo "1) YES"
                        echo "2) NO"
                        read -p "Enter your choice [1-2]: " choice

                        case $choice in
                            1)
                                sudo apt-get install obabel
                                ;;
                            2) return ;;
                        esac
                    done
                    return
                fi
                ;;
            2)
                mol_file="lig.mol2"
                perl_sort_file="sort_mol2_bonds.pl"
                if [ ! -f "$mol_file" ]; then
                    echo "$mol_file does not exist."
                    echo "Download the file?"
                    while true; do
                        echo "Select option"
                        echo "1) YES"
                        echo "2) NO"
                        read -p "Enter your choice [1-2]: " choice

                        case $choice in
                            1)
                                wget http://www.mdtutorials.com/gmx/complex/Files/sort_mol2_bonds.pl
                                ;;
                            2) return ;;
                        esac
                    done
                fi
                
                if [ -f "$perl_sort_file" ]; then
                    check_file_exists "lig_fix.mol2" || return
                    perl sort_mol2_bonds.pl lig.mol2 lig_fix.mol2
                else
                    echo "$perl_sort_file does not exist."
                    exit 1
                fi
                ;;
            3)
                if [ ! -f "lig_fix.mol2" ]; then
                    echo "lig_fix.mol2 does not exist. Please prepare it first."
                    exit 1
                fi
                check_file_exists "lig_fix.prm" || return
                python3 cgenff_charmm2gmx_py3_nx2.py LIG lig_fix.mol2 lig_fix.str charmm36-jul2022.ff || { echo "Error: Failed to prepare ligand parameter file."; exit 1; }
                ;;
            4)
                if [ ! -f "lig_ini.pdb" ]; then
                    echo "lig_ini.pdb does not exist."
                    exit 1
                fi
                check_file_exists "lig.gro" || return
                gmx editconf -f lig_ini.pdb -o lig.gro || { echo "Error: Failed to prepare ligand topology."; exit 1; }
                ;;
            5)
                echo "Generating complex.gro file..."
                if [ ! -f "protein.gro" ]; then
                    echo "protein.gro does not exist. Please prepare it first."
                    exit 1
                fi
                if [ ! -f "lig.gro" ]; then
                    echo "lig.gro does not exist. Please prepare it first."
                    exit 1
                fi
                python3 merge.py || { echo "Error: Failed to generate complex.gro."; exit 1; }
                echo "complex.gro generated successfully."

                # Integrate program 2 to edit topol.top file
                echo "Editing topol.top file..."
                
                if [ ! -f "topol.top" ]; then
                    echo "topol.top does not exist."
                    exit 1
                fi

                # Add an empty line and 'lig.itp' after two lines following 'posre.itp'
                sed -i '/#include "posre.itp"/{n;a\
\
; Include ligand topology\
#include "lig.itp"
}' topol.top

                # Add ligand parameters inclusion
                sed -i '/; Include forcefield parameters/{n;a\
\
; Include ligand parameters\
#include "lig.prm"
}' topol.top

                # Add ligand entry at the end
                echo "LIG                 1" >> topol.top

                echo "topol.top file updated successfully."
                
                # Return to main menu after successful processing
                return
                ;;
            6)
                return
                ;;
            *)
                echo "Invalid option! Please select between 1 and 4."
                ;;
        esac
    done
}

# Function to define box and solvate the system
define_box_and_solvate() {
    echo "Defining box and solvating system..."
    if [ ! -f "complex.gro" ]; then
        echo "complex.gro does not exist."
        exit 1
    fi
    check_file_exists "newbox.gro" || return
    gmx editconf -f complex.gro -o newbox.gro -bt dodecahedron -d 1.0 || { echo "Error: Failed to define the box."; exit 1; }
    check_file_exists "solv.gro" || return
    gmx solvate -cp newbox.gro -cs spc216.gro -p topol.top -o solv.gro || { echo "Error: Failed to solvate the system."; exit 1; }
}

# Function to add ions
add_ions() {
    echo "Adding ions..."
    if [ ! -f "solv.gro" ]; then
        echo "solv.gro does not exist."
        exit 1
    fi
    
    if [ ! -f "ions.mdp" ]; then
        echo "ions.mdp does not exist. Downloading..."
        wget -nc http://www.mdtutorials.com/gmx/complex/Files/ions.mdp
    fi
    
    check_file_exists "ions.tpr" || return
    gmx grompp -f ions.mdp -c solv.gro -p topol.top -o ions.tpr || { echo "Error: Failed to prepare ions."; exit 1; }
    check_file_exists "solv_ions.gro" || return
    gmx genion -s ions.tpr -o solv_ions.gro -p topol.top -pname NA -nname CL -neutral || { echo "Error: Failed to add ions."; exit 1; }
}

# Function to run energy minimization
energy_minimization() {
    echo "Running energy minimization..."
    if [ ! -f "solv_ions.gro" ]; then
        echo "solv_ions.gro does not exist."
        exit 1
    fi
    
    if [ ! -f "em.mdp" ]; then
        echo "em.mdp does not exist. Downloading..."
        wget -nc http://www.mdtutorials.com/gmx/complex/Files/em.mdp
    fi
    
    check_file_exists "em.tpr" || return
    gmx grompp -f em.mdp -c solv_ions.gro -p topol.top -o em.tpr || { echo "Error: Failed to prepare for energy minimization."; exit 1; }
    check_file_exists "em.gro" || return
    gmx mdrun -v -deffnm em || { echo "Error: Energy minimization failed."; exit 1; }
}

# Function to run equilibrium
equilibrium() {
    echo "Running equilibrium..."
    while true; do
        echo "---------------------------"
        echo "   Equilibrium Menu"
        echo "---------------------------"
        echo "1) Ligand Restraining"
        echo "2) Thermostats"
        echo "3) NVT Equilibration"
        echo "4) NPT Equilibration"
        echo "5) Back to Main Menu"
        read -p "Enter your choice [1-5]: " equil_choice

        case $equil_choice in
            1)
                echo "Ligand restraining..."
                if [ ! -f "lig.gro" ]; then
                    echo "lig.gro does not exist."
                    exit 1
                fi
                check_file_exists "index_lig.ndx" || return
                gmx make_ndx -f "lig.gro" -o "index_lig.ndx" || { echo "Error: Failed to create index file."; exit 1; }
                check_file_exists "posre_lig.itp" || return
                gmx genrestr -f "lig.gro" -n "index_lig.ndx" -o "posre_lig.itp" -fc 1000 1000 1000 || { echo "Error: Failed to generate position restraints."; exit 1; }
                echo "Ligand restraining completed."
                
                # Integrate program 2 to edit topol.top file
                echo "Editing topol.top file..."
                
                if [ ! -f "topol.top" ]; then
                    echo "topol.top does not exist."
                    exit 1
                fi

                # Add an empty line and 'lig.itp' after two lines following 'posre.itp'
                sed -i '/#include "lig.itp"/{n;a\
; Ligand position restraints\
#ifdef POSRES_LIG\
#include "posre_lig.itp"\
#endif
}' topol.top

                echo "topol.top file updated successfully."
                ;;

            2)
                echo "Setting up thermostats..."
                if [ ! -f "em.gro" ]; then
                    echo "em.gro does not exist."
                    exit 1
                fi
                check_file_exists "index.ndx" || return
                gmx make_ndx -f em.gro -o index.ndx || { echo "Error: Failed to create index file for thermostats."; exit 1; }
                echo "Thermostats setup completed."
                ;;
            3)
                echo "Running NVT equilibration..."
                if [ ! -f "em.gro" ]; then
                    echo "em.gro does not exist."
                    exit 1
                fi
                
                if [ ! -f "nvt.mdp" ]; then
                    echo "nvt.mdp does not exist. Downloading..."
                    wget -nc http://www.mdtutorials.com/gmx/complex/Files/nvt.mdp
                fi
                
                check_file_exists "nvt.tpr" || return
                gmx grompp -f nvt.mdp -c em.gro -r em.gro -p topol.top -n index.ndx -o nvt.tpr || { echo "Error: Failed to prepare NVT equilibration."; exit 1; }
                check_file_exists "nvt.gro" || return
                gmx mdrun -deffnm nvt -v || { echo "Error: NVT equilibration failed."; exit 1; }
                ;;
            4)
                echo "Running NPT equilibration..."
                if [ ! -f "nvt.gro" ]; then
                    echo "nvt.gro does not exist."
                    exit 1
                fi
                
                if [ ! -f "npt.mdp" ]; then
                    echo "npt.mdp does not exist. Downloading..."
                    wget -nc http://www.mdtutorials.com/gmx/complex/Files/npt.mdp
                fi
                
                check_file_exists "npt.tpr" || return
                gmx grompp -f npt.mdp -c nvt.gro -r nvt.gro -p topol.top -n index.ndx -o npt.tpr || { echo "Error: Failed to prepare NPT equilibration."; exit 1; }
                check_file_exists "npt.gro" || return
                gmx mdrun -deffnm npt -v || { echo "Error: NPT equilibration failed."; exit 1; }
                ;;
            5)
                echo "Returning to main menu..."
                return
                ;;
            *)
                echo "Invalid option! Please select between 1 and 5."
                ;;
        esac
    done
}

# Function to run production MD
production_md() {
    echo "Running production MD..."
    if [ ! -f "npt.gro" ]; then
        echo "npt.gro does not exist."
        exit 1
    fi

    if [ ! -f "md.mdp" ]; then
        echo "md.mdp does not exist. Downloading..."
        wget -nc http://www.mdtutorials.com/gmx/complex/Files/md.mdp
    fi
    
    check_file_exists "md.tpr" || return
    gmx grompp -f md.mdp -c npt.gro -p topol.top -n index.ndx -o md.tpr || { echo "Error: Failed to prepare production MD."; exit 1; }
    check_file_exists "md.xtc" || return
    gmx mdrun -deffnm md -v || { echo "Error: Production MD failed."; exit 1; }
}

# Function to run analysis
run_analysis() {
    echo "Running analysis..."
    while true; do
        echo "---------------------------"
        echo "       Analysis Menu"
        echo "---------------------------"
        echo "1) Recentering and Rewrapping Coordinates"
        echo "2) Find RMSD"
        echo "3) Protein-Ligand Interaction Energy"
        echo "4) Back to Main Menu"
        read -p "Enter your choice [1-4]: " analysis_choice

        case $analysis_choice in
            1)
                echo "Recentering and Rewrapping Coordinates..."
                check_file_exists "md_0_10_center.xtc" || return
                gmx trjconv -s md.tpr -f md.xtc -o md_center.xtc -center -pbc mol -ur compact || exit 1
                check_file_exists "start.pdb" || return
                gmx trjconv -s md.tpr -f md_center.xtc -o start.pdb -dump 0 || exit 1
                check_file_exists "md_0_10_fit.xtc" || return
                gmx trjconv -s md.tpr -f md_center.xtc -o md_fit.xtc -fit rot+trans || exit 1
                ;;
            2)
                echo "Finding RMSD..."
                check_file_exists "rmsd_jz4.xvg" || return
                gmx rms -s em.tpr -f md_center.xtc -n index.ndx -tu ns -o rmsd_lig.xvg || exit 1
                ;;
            3)
                echo "Calculating Protein-Ligand Interaction Energy..."
                check_file_exists "interaction_energy.xvg" || return
                gmx grompp -f ie.mdp -c npt.gro -t npt.cpt -p topol.top -n index.ndx -o ie.tpr || exit 1
                check_file_exists "ie.edr" || return
                gmx mdrun -deffnm ie -rerun md.xtc -nb cpu || exit 1
                check_file_exists "interaction_energy.xvg" || return
                gmx energy -f ie.edr -o interaction_energy.xvg || exit 1
                ;;
            4)
                echo "Returning to Main Menu..."
                return
                ;;
            *)
                echo "Invalid option! Please select between 1 and 4."
                ;;
        esac
    done
}

banner() {
    # Main script loop
    clear
    echo
    # Print the colored ASCII art
    echo -e "${LIGHT_RED}  __________________    _________   ____.______________      ${RESET}"
    echo -e "${LIGHT_RED} /  _____/\\______   \\  /  _  \\   \\ /   /|   \\__    ___/${RESET}__.__. "
    echo -e "${LIGHT_RED}/   \\  ___ |       _/ /  /_\\  \\   Y   / |   | |    | ${RESET}<   |  | "
    echo -e "${LIGHT_RED}\\    \\_\\  \\|    |   \\/    |    \\     /  |   | |    |  ${RESET}\\___  | "
    echo -e "${LIGHT_RED} \\______  /|____|_  /\\____|__  /\\___/   |___| |____|  ${RESET}/ ____| "
    echo -e "${LIGHT_RED}        \\/        \\/         \\/                       ${RESET}\\/      "
    echo
    echo -e "${WHITE}  [${LIGHT_RED}G${NC}ROMACS ${LIGHT_RED}R${NC}apid ${LIGHT_RED}A${NC}nalysis & ${LIGHT_RED}V${NC}isualization ${LIGHT_RED}I${NC}nterface ${LIGHT_RED}T${NC}ool -y]${NC}"
    echo
}

banner
check_internet
echo
check_dependencies
echo -e "${LIGHT_CYAN}Simulation type: Protein-Ligand Complex${NC}"
echo
# Main script loop
echo "Welcome to the GROMACS simulation"
echo 
echo "Please keep your docked protein and ligand complex ready in the working directory."
echo "Please process your protein.pdbqt by removing water molecules or any HETATM's available"
echo "and convert it into protein.pdb format"
echo 

while true; do
    echo -e "${YELLOW}------------------------------------"
    echo -e "             Main Menu"
    echo -e "------------------------------------${NC}"
    echo -e "${LIGHT_PURPLE}[${NC}01${LIGHT_PURPLE}]${NC} Retrieve Complex Molecules"
    echo -e "${LIGHT_PURPLE}[${NC}02${LIGHT_PURPLE}]${NC} Prepare Protein Topology"
    echo -e "${LIGHT_PURPLE}[${NC}03${LIGHT_PURPLE}]${NC} Prepare Ligand Topology"
    echo -e "${LIGHT_PURPLE}[${NC}04${LIGHT_PURPLE}]${NC} Define box and solvate the system"
    echo -e "${LIGHT_PURPLE}[${NC}05${LIGHT_PURPLE}]${NC} Add ions"
    echo -e "${LIGHT_PURPLE}[${NC}06${LIGHT_PURPLE}]${NC} Energy minimization"
    echo -e "${LIGHT_PURPLE}[${NC}07${LIGHT_PURPLE}]${NC} Equilibrium"
    echo -e "${LIGHT_PURPLE}[${NC}08${LIGHT_PURPLE}]${NC} Production MD"
    echo -e "${LIGHT_PURPLE}[${NC}09${LIGHT_PURPLE}]${NC} Analysis"
    echo -e "${LIGHT_PURPLE}[${NC}10${LIGHT_PURPLE}]${NC} ${LIGHT_RED}Exit${NC}"
    echo -e "${YELLOW}------------------------------------${NC}"

    choice=$(prompt_user "Enter your choice [1-9]: ")

    case $choice in
        1) retrieve_complex;;
        2) prepare_protein_topology ;;
        3) prepare_ligand_topology ;;
        4) define_box_and_solvate ;;
        5) add_ions ;;
        6) energy_minimization ;;
        7) equilibrium ;;
        8) production_md ;;
        9) run_analysis ;;
        10)
            echo -e "${LIGHT_YELLOW}Thanks for using GRAVITy!${NC}"
            echo "Exiting..."
            echo
            exit 0
            ;;
        *)
            echo -e "${LIGHT_RED}Invalid option! Please select between 1 and 11.${NC}"
            sleep 1.0
            ;;
    esac
done

